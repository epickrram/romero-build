<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Romero Server</title>
    <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
</head>
<body>
<div id="build-status">
</div>
<div id="build-details">
</div>
<div id="running-jobs">
</div>

<script language="javascript" type="text/javascript">

function getBuildStatus()
{
    invoke('build/status.json', function(data)
		{
			if(data)
			{
                var buildStatus = data.status;
				$("#build-status").text(data.status)
                $("#build-details").html(['<span>Total jobs: ', data.totalJobs, '</span><br/><span>Remaining jobs:', data.remainingJobs, '</span>'].join(''));
                if(isCurrentlyBuilding(buildStatus))
                {
                    displayRunningJobs();
                }
			}
		});
}

function displayRunningJobs()
{
    invoke('build/runningJobs.json', function(data)
		{
			if(data)
			{
                var currentTime = new Date().getTime();
                var html = [];
                html.push("Running agents<br/>");
                for(var i = 0, n = data.length; i < n; i++)
                {
                    html.push("<span>");
                    html.push(data[i].agentId);
                    html.push(" ");
                    html.push(toTimeString(currentTime - Number(data[i].startedTimestamp)));
                    html.push("</span><br/>");
                }
                $("#running-jobs").html(html.join(''));
			}
		});
}

function toTimeString(durationMillis)
{
    var millis = durationMillis % 1000;
    var seconds = Math.floor(durationMillis / 1000) % 60;
    var minutes = Math.floor(seconds/60);
    var hours = Math.floor(minutes/60);

    return [zeroPad(hours), zeroPad(minutes), zeroPad(seconds)].join(':');
}

function zeroPad(value)
{
    return value < 10 ? '0'+value : ''+value;
}

function invoke(postUrl, successHandler)
{
	$.ajax({
		url: postUrl,
        type: 'POST',
		success: successHandler
	});
}

function isCurrentlyBuilding(buildStatus)
{
    return "BUILDING" == buildStatus || "WAITING_FOR_TESTS_TO_COMPLETE" == buildStatus;
}

$(document).ready(function()
{
    var interval = setInterval('getBuildStatus()', 2000)
});

</script>
</body>
</html>